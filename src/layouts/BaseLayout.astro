---
// src/layouts/BaseLayout.astro - VERSION CORRIG√âE FINALE

import Menu from "@partials/components/Menu";
import Footer from "@partials/components/Footer.astro";
import FooterMenu from "@partials/components/FooterMenu.astro";
import Seo from "@partials/components/Seo.astro";
import { companyInfos, getSeoKeywords, getSchemaForPage } from '@js/data/CompanyData';

// ‚úÖ IMPORT SCSS DYNAMIQUE - Hot-reload fonctionnel
import '../scss/main.scss';

export interface Props {
  title: string;
  description?: string;
  pageClass?: string;
  dataPage?: string;
  dataModules?: string;
  dataVariant?: string;
  pageType?: 'home' | 'entreprise' | 'general';
  seo?: {
    url: string;
    image?: string;
    schemaType?: "LocalBusiness" | "Organization" | "Article" | "Review";
  };
  preloadImage?: string;
}

const {
  title,
  description,
  pageClass,
  dataPage,
  dataModules,
  dataVariant = "white",
  pageType = 'home',
  seo,
  preloadImage
} = Astro.props;

// üéØ G√âN√âRATION SEO DYNAMIQUE
const getSeoTitle = (title: string, pageType: 'home' | 'entreprise' | 'general') => {
  const baseName = "SBG Coaching - Samuel Billa Garcia";
  
  switch(pageType) {
    case 'entreprise':
      return `${title} | Coaching Sportif Entreprise Li√®ge | ${baseName}`;
    case 'general':
      return `${title} | Personal Trainer Li√®ge | ${baseName}`;
    default:
      return `${title} | ${baseName}`;
  }
};

const getSeoDescription = (description?: string, pageType?: string) => {
  if (description) return description;
  
  switch(pageType) {
    case 'entreprise':
      return "Coaching sportif en entreprise √† Li√®ge : team building, bien-√™tre au travail, coh√©sion d'√©quipe. Programme sur mesure Province de Li√®ge. Devis gratuit.";
    case 'general':
      return "Coach sportif personnel √† Li√®ge. Programme fitness personnalis√©, perte de poids, musculation. Premi√®re s√©ance offerte. Province de Li√®ge.";
    default:
      return "SBG Coaching - Coach sportif √† Li√®ge. Coaching personnel et entreprise, team building, bien-√™tre. Samuel Billa Garcia, coach certifi√© Province de Li√®ge.";
  }
};

const optimizedTitle = getSeoTitle(title, pageType);
const optimizedDescription = getSeoDescription(description, pageType);
const keywords = getSeoKeywords(pageType === 'home' ? 'all' : pageType);
const canonicalUrl = seo?.url || `https://sbgcoaching.be${Astro.url.pathname}`;
const ogImage = seo?.image || '/img/og-coaching-liege.webp';
---

<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- üèÜ SEO META TAGS OPTIMIS√âS -->
    <title>{optimizedTitle}</title>
    <meta name="description" content={optimizedDescription} />
    <meta name="keywords" content={keywords.join(', ')} />
    <meta name="author" content="Samuel Billa Garcia - SBG Coaching" />
    <meta name="robots" content="index, follow, max-image-preview:large" />

    <!-- üîó CANONICAL -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- üéØ FAVICON OPTIMIS√â -->
    <link rel="icon" type="image/svg+xml" href="/img/logo.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/logo.svg" />
    <meta name="theme-color" content="#ffffff" />

    <!-- ‚ö° PRELOAD RESSOURCES CRITIQUES -->
    <link rel="preload" as="font" href="/font/Nexa-Bold.woff2" type="font/woff2" crossorigin />
    <link rel="preload" as="font" href="/font/Nexa-Regular.woff2" type="font/woff2" crossorigin />
    
    {preloadImage && (
      <link rel="preload" as="image" href={preloadImage} />
    )}

    <!-- üé® FONTS GOOGLE OPTIMIS√âES -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />

    <!-- üì± OPEN GRAPH COACHING -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={optimizedTitle} />
    <meta property="og:description" content={optimizedDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={`https://sbgcoaching.be${ogImage}`} />
    <meta property="og:site_name" content="SBG Coaching" />

    <!-- üè¢ SCHEMA.ORG JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(getSchemaForPage(pageType))}></script>

    <!-- üìä GOOGLE ANALYTICS 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>

    <slot name="head" />
  </head>

  <body
    class={pageClass ?? ""}
    data-page={dataPage ?? ""}
    data-module={dataModules ?? ""}
    data-variant={dataVariant}
  >
    <!-- üèóÔ∏è NAVIGATION OPTIMIS√âE -->
    <Menu client:only="react" variant={dataVariant as "white" | "black"} />

    <!-- üìÑ CONTENU PRINCIPAL -->
    <slot />

    <!-- ü¶∂ FOOTER CONDITIONNEL -->
    {["legal", "privacy-policy", "thanks", "program"].includes(dataPage ?? "") ? (
      <FooterMenu />
    ) : ["contact", "rdv"].includes(dataPage ?? "") ? null : (
      <Footer />
    )}

    <!-- üöÄ SCRIPTS PERFORMANCE CORRIG√âS -->
    <script define:vars={{ 
      optimizedTitle, 
      canonicalUrl, 
      pageType, 
      dataVariant 
    }}>
      // ‚úÖ Fonction s√©curis√©e - c√¥t√© client uniquement
      (function() {
        if (typeof window === 'undefined') return;

        // ‚úÖ Initialiser dataLayer et gtag
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          window.dataLayer.push(arguments);
        }

        // ‚úÖ Web Vitals avec gestion d'erreurs
        import('web-vitals')
          .then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
            getCLS(metric => gtag('event', 'CLS', { 
              event_category: 'Web Vitals', 
              value: Math.round(metric.value * 1000) 
            }));
            getFID(metric => gtag('event', 'FID', { 
              event_category: 'Web Vitals', 
              value: Math.round(metric.value) 
            }));
            getFCP(metric => gtag('event', 'FCP', { 
              event_category: 'Web Vitals', 
              value: Math.round(metric.value) 
            }));
            getLCP(metric => gtag('event', 'LCP', { 
              event_category: 'Web Vitals', 
              value: Math.round(metric.value) 
            }));
            getTTFB(metric => gtag('event', 'TTFB', { 
              event_category: 'Web Vitals', 
              value: Math.round(metric.value) 
            }));
          })
          .catch(err => console.log('Web Vitals non disponible:', err));

        // ‚úÖ Google Analytics 4 configuration
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID', {
          page_title: optimizedTitle,
          page_location: canonicalUrl,
          custom_map: {
            'custom_dimension_1': pageType,
            'custom_dimension_2': dataVariant
          }
        });

        // ‚úÖ Conversion tracking
        function trackCoachingEvent(eventName, parameters) {
          gtag('event', eventName, {
            event_category: 'coaching',
            page_type: pageType,
            ...(parameters || {})
          });
        }

        // ‚úÖ Engagement tracking
        let engagementTimer = 0;
        const engagementInterval = setInterval(() => {
          engagementTimer += 5;
          if (engagementTimer === 30) {
            trackCoachingEvent('engagement_30s');
          }
          if (engagementTimer === 60) {
            trackCoachingEvent('engagement_1min');
            clearInterval(engagementInterval);
          }
        }, 5000);

        // ‚úÖ Service Worker (optionnel)
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(registration => console.log('SW registered:', registration))
              .catch(error => console.log('SW registration failed:', error));
          });
        }
      })();
    </script>
  </body>
</html>
